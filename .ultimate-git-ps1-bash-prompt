# Customize BASH PS1 prompt to show current GIT repository and branch.
# Original from http://mediadoneright.com/content/ultimate-git-ps1-bash-prompt

# This prompt depends on `romkatv/gitstatus` to improve its performances.
# (it will work without it but will be slower).
# @see https://github.com/romkatv/gitstatus
#
# To enable `romkatv/gitstatus`, download it and add this line to your ~.bashrc:
#   export _GITSTATUS_PLUGIN_PATH=/path/to/gitstatus.plugin.sh

source "$_GITSTATUS_PLUGIN_PATH" || export _DISABLE_GITSTATUS=true

# Regular Colors
_black_='\e[0;30m'
_red_='\e[0;31m'
_green_='\e[0;32m'
_yellow_='\e[0;33m'
_blue_='\e[0;34m'
_purple_='\e[0;35m'
_cyan_='\e[0;36m'
_white_='\e[0;37m'

# Bold
_bblack_='\e[1;30m'
_bred_='\e[1;31m'
_bgreen_='\e[1;32m'
_byellow_='\e[1;33m'
_bblue_='\e[1;34m'
_bpurple_='\e[1;35m'
_bcyan_='\e[1;36m'
_bwhite_='\e[1;37m'

# Underline
_ublack_='\e[4;30m'
_ured_='\e[4;31m'
_ugreen_='\e[4;32m'
_uyellow_='\e[4;33m'
_ublue_='\e[4;34m'
_upurple_='\e[4;35m'
_ucyan_='\e[4;36m'
_uwhite_='\e[4;37m'

# Background
_on_black_='\e[40m'
_on_red_='\e[41m'
_on_green_='\e[42m'
_on_yellow_='\e[43m'
_on_blue_='\e[44m'
_on_purple_='\e[45m'
_on_cyan_='\e[46m'
_on_white_='\e[47m'

# High Intensty
_iblack_='\e[0;90m'
_ired_='\e[0;91m'
_igreen_='\e[0;92m'
_iyellow_='\e[0;93m'
_iblue_='\e[0;94m'
_ipurple_='\e[0;95m'
_icyan_='\e[0;96m'
_iwhite_='\e[0;97m'

# Bold High Intensty
_biblack_='\e[1;90m'
_bired_='\e[1;91m'
_bigreen_='\e[1;92m'
_biyellow_='\e[1;93m'
_biblue_='\e[1;94m'
_bipurple_='\e[1;95m'
_bicyan_='\e[1;96m'
_biwhite_='\e[1;97m'

# High Intensty backgrounds
_on_iblack_='\e[0;100m'
_on_ired_='\e[0;30;101m'
_on_igreen_='\e[0;102m'
_on_iyellow_='\e[0;103m'
_on_iblue_='\e[0;104m'
_on_ipurple_='\e[10;95m'
_on_icyan_='\e[0;106m'
_on_iwhite_='\e[0;107m'

# Reset
_off_='\e[0m'

_on_debug() {
    if [ -n "$_PROMPT_DEBUG" ]; then
        >&2 $@
    fi
}

_init_git_prompt() {

    # Use `romkatv/gitstatus` when available.
    if [[ -z "$_DISABLE_GITSTATUS" ]] && gitstatus_query && [[ "$VCS_STATUS_RESULT" == ok-sync ]]; then
        _on_debug echo 'Using `romkatv/gitstatus`! :)'

        local ahead_count="$VCS_STATUS_COMMITS_AHEAD"
        local behind_count="$VCS_STATUS_COMMITS_BEHIND"
        local staged_count="$VCS_STATUS_NUM_STAGED"
        local unstaged_count="$VCS_STATUS_NUM_UNSTAGED"
        local untracked_count="$VCS_STATUS_NUM_UNTRACKED"
        # Not supported, yet, see https://github.com/romkatv/gitstatus/issues/40
        local unmerged_count=0

    # Fallback on slower "git status".
    else
        _on_debug echo 'Fallbacking on git status. :('

        local git_status=$(git status --branch --untracked-files=all --porcelain)
        local unmerged_pattern='U.\|.U\|.A'

        local ahead_count="$(printf -- "$git_status" | grep -o '\[ahead [[:digit:]]*' | grep -o '[[:digit:]]*')"
        local behind_count="$(printf -- "$git_status" | grep -o 'behind [[:digit:]]*' | grep -o '[[:digit:]]*')"
        local status_flags="$(printf -- "$git_status" | sed 's/^\(..\).*$/\1/')"
        local staged_count="$(printf -- "$status_flags" | grep -v "$unmerged_pattern" | grep -c '^[AMD].')"
        local unstaged_count="$(printf -- "$status_flags" | grep -v "$unmerged_pattern" | grep -c '^.[AMD]')"
        local untracked_count="$(printf -- "$status_flags" | grep -c '??')"
        local unmerged_count="$(printf -- "$status_flags" | grep -c "$unmerged_pattern")"
    fi
    local dirty_files_count="$(($staged_count + $unstaged_count + $untracked_count))"

    if [ "$dirty_files_count" -ne 0 ]; then
        local state_color="${_ired_}"
        local state_template='{%s}'
    else
        local state_color+="${_green_}"
        local state_template='(%s)'
    fi

    local repo_state="$state_color"
    if [ "$behind_count" -ne 0 ]; then
        repo_state+="⇣ "
    fi
    # See https://stackoverflow.com/a/55082075/3877971 for __git_ps1
    repo_state+="$(__git_ps1 "${state_template}")"
    if [ "$ahead_count" -ne 0 ]; then
        repo_state+="⇡ "
    fi
    repo_state+="${_off_}"

    local black_dot="${_iblack_}·${_off_}"
    local status_prompt=''
    # Staged.
    if [ "${staged_count}" -ne 0 ]; then
        status_prompt+="${_igreen_}${staged_count}${_off_}"
    fi
    # "·"
    if [ "${dirty_files_count}" -ne 0 ]; then
        status_prompt+="${black_dot}"
    fi
    # Unstaged.
    if [ "${unstaged_count}" -ne 0 ]; then
        status_prompt+="${_yellow_}${unstaged_count}${_off_}"
    fi
    # "·"
    if [ "${dirty_files_count}" -ne 0 ]; then
        status_prompt+="${black_dot}"
    fi
    # Untracked.
    if [ "${untracked_count}" -ne 0 ]; then
        status_prompt+="${_iblue_}${untracked_count}${_off_}"
    fi
    # Unmerged.
    if [ "${unmerged_count}" -ne 0 ]; then
        status_prompt+="${black_dot}${_on_ired_}${unmerged_count}${_off_}"
    fi
    # " "
    if [ "${dirty_files_count}" -ne 0 ]; then
        status_prompt+=" "
    fi

    # Specific to my workflow.
    # Adds an indicator if the latest commit is a temporary one (ctmp alias).
    local latest_commit_msg="$(git log --oneline --format=%B -n 1 HEAD -- 2> /dev/null | head -n 1)"
    if [ "$latest_commit_msg" = "temporary-commit" ]; then
        local tmp_commit_indicator="${_ipurple_} ⭑${_off_}"
    fi

    git_prompt="${repo_state}${tmp_commit_indicator} ${status_prompt}"
}

_init_node_prompt() {
    command -v node >/dev/null
    local is_node_available=$?

    if [ $is_node_available -eq 0 ]; then
        local node_version="$(node --version)"
        node_prompt="${_iblack_}[${node_version}, "

        if [ $NODE_ENV != 'development' ]; then
            node_prompt+="${_yellow_}${NODE_ENV}${_iblack_}"
        else
            node_prompt+="${NODE_ENV}"
        fi
        node_prompt+="]${_off_} "
    fi
}

_get_prompt() {
    git rev-parse --is-inside-work-tree >/dev/null 2>&1
    local in_git_repo=$?

    # Date
    local hour="${_iblack_}$(date +"%H:%M:%S")${_off_}"

    # Path
    local path="$(dirs +0)"

    # Status
    if [ $status -eq 130 ]; then
        # ^C
        local status_indicator="${_iyellow_}✕${_off_} "
    elif [ $status -ne 0 ]; then
        local status_indicator="${_ired_}⏺${_off_} "
    fi

    _init_node_prompt

    if [ "$in_git_repo" -eq 0 ]; then
        _init_git_prompt
        local path_prompt="${_iyellow_}${path}${_off_}"
    else
        local path_prompt="${_yellow_}${path}${_off_}"
    fi

    echo -e "${hour} ${git_prompt}${path_prompt} ${node_prompt}${status_indicator}\n\$ "
}

# Restart the gitstatus daemon.
# See https://github.com/romkatv/gitstatus/blob/9bbf75b0a89c8e78b80a29e31e010ce45a791e8c/gitstatus.plugin.sh#L23-L38
gitstatus_stop && gitstatus_start -s -1 -u -1 -d -1

_debuggable_prompt() {
    # Get status early, before the first command.
    local status=$?
    if [ -n "$_PROMPT_DEBUG" ]; then
        echo -n 'Prompt time: '
        (time _get_prompt) 2>&1 > /dev/null | grep real | sed 's/^.*m\(.*\)$/\1/'
    fi
    _get_prompt
}

export PS1='$(_debuggable_prompt)'
